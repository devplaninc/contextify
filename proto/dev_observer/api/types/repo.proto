syntax = "proto3";

package dev_observer.api.types.repo;

import "google/protobuf/timestamp.proto";
import "dev_observer/api/types/ai.proto";
import "dev_observer/api/types/observations.proto";

option go_package = "github.com/devplaninc/contextify/clients/go/contextify";

enum GitProvider {
  GITHUB = 0;
  BIT_BUCKET = 1;
}

message GitRepository {
  string id = 1;
  string name = 2;
  string full_name = 3;
  string url = 4;
  string description = 5;
  GitProvider provider = 6;
  optional GitProperties properties = 7;
}

message GitProperties {
  optional GitAppInfo app_info = 1;
  optional GitMeta meta = 2;
  optional BitBucketInfo bit_bucket_info = 3;
}

message BitBucketInfo {
  string workspace_uuid = 1;
}

message GitMeta {
  google.protobuf.Timestamp last_refresh = 1;
  optional string clone_url = 2;
  optional int32 size_kb = 3;
  optional TokensInfo tokens_info = 4;
}

message TokensInfo {
  google.protobuf.Timestamp created_at = 1;
  int32 tokens_count = 2;
}

message GitAppInfo {
  google.protobuf.Timestamp last_refresh = 1;
  optional int32 installation_id = 2;
}

message ReposFilter {
  optional GitProvider provider = 1;
  optional string owner = 2;
}

message CodeResearchMeta {
  string summary = 1;
  google.protobuf.Timestamp created_at = 2;
  string repo_full_name = 3;
  string repo_url = 4;
  string area_title = 5;
  api.types.observations.ObservationKey dir_key = 6;
}

message CodeResearchAreaMeta {
  api.types.observations.ObservationKey research_key = 1;
  CodeResearchMeta meta = 2;
}

message CodeResearchOrganizationMeta {
  repeated CodeResearchAreaMeta area_metas = 1;
}

message ResearchLog {
  repeated ResearchLogItem items = 1;
  google.protobuf.Timestamp started_at = 2;
  google.protobuf.Timestamp finished_at = 3;
  optional api.types.ai.UsageMetadata total_usage = 6;
}

message ResearchLogItem {
  string observations = 1;
  repeated ToolCallResult tool_calls = 2;
  google.protobuf.Timestamp started_at = 3;
  google.protobuf.Timestamp finished_at = 4;
  string summary = 5;
  optional api.types.ai.UsageMetadata usage = 6;
}

message ToolCallResult {
  string requested_tool_call = 1;
  string result = 2;
  ToolCallStatus status = 3;

  enum ToolCallStatus {
    UNPROCESSED = 0;
    SUCCESS=1;
    FAILURE=2;
  }
}